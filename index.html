<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
<meta charset="UTF-8">
<title>Expense Splitter â€“ Final</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
.settle-header{
  background-color:var(--bs-secondary-bg);
  font-weight:600;
}
body{background:var(--bs-body-bg);color:var(--bs-body-color)}
.card{border-radius:16px}
input,select,button{border-radius:12px!important}
.table{font-size:14px}
.split-card{cursor:pointer}
.split-card:hover{background:rgba(255,255,255,0.05)}
#customMembers{max-height:0;opacity:0;overflow:hidden;transition:.3s}
#customMembers.show{max-height:600px;opacity:1}
</style>
</head>

<body>
<div class="container my-3">

<div class="d-flex justify-content-between align-items-center mb-3">
  <h4>ğŸ’¸ Expense Splitter</h4>
  <button class="btn btn-outline-secondary btn-sm" onclick="toggleTheme()">ğŸŒ™ / â˜€ï¸</button>
</div>

<!-- MEMBERS -->
<div class="card p-3 mb-3">
<h6>Add Member</h6>
<div class="input-group">
<input id="memberInput" class="form-control" placeholder="Member name"
 onkeydown="if(event.key==='Enter')addMember()">
<button class="btn btn-primary" onclick="addMember()">Add</button>
</div>
<ul class="list-group mt-2" id="memberList"></ul>
</div>

<!-- ADD / EDIT EXPENSE -->
<div class="card p-3 mb-3">
<h6 id="expenseFormTitle">Add Expense</h6>

<select class="form-select mb-2" id="expenseType" onchange="renderTypeFields()">
  <option value="">Expense type</option>
  <option value="Travel">ğŸš• Travel</option>
  <option value="Food">ğŸ” Food</option>
  <option value="Other">ğŸ›’ Other</option>
</select>

<div id="typeFields"></div>

<input id="expenseAmount" type="number" class="form-control mb-2" placeholder="Amount â‚¹">

<select id="paidBy" class="form-select mb-2"></select>

<div class="card p-2 mb-2 split-card" onclick="selectSplit('equal')">
  <div class="form-check">
    <input class="form-check-input" type="radio" name="splitType"
           id="splitEqual" value="equal" checked>
    <label class="form-check-label fw-semibold">Split equally</label>
  </div>
</div>

<div class="card p-2 split-card" onclick="selectSplit('custom')">
  <div class="form-check">
    <input class="form-check-input" type="radio" name="splitType"
           id="splitCustom" value="custom">
    <label class="form-check-label fw-semibold">Split selected members</label>
  </div>
</div>

<div id="customMembers" class="mt-2"></div>

<button class="btn btn-success w-100 mt-3" onclick="saveExpense()">Save Expense</button>
<button class="btn btn-outline-secondary w-100 mt-2 d-none"
        id="cancelEditBtn" onclick="cancelEdit()">Cancel Edit</button>
</div>

<!-- EXPENSE LIST -->
<div class="card p-3 mb-3">
<h6>Expenses</h6>
<table class="table table-sm" id="expenseTable"></table>
</div>

<!-- FINAL SETTLEMENT -->
<div class="card p-3 mb-3">
<h6>Final Settlement</h6>
<table class="table table-sm" id="matrixTable"></table>
</div>

<!-- SPENDING -->
<div class="card p-3 mb-3">
<h6>Total Individual Spending</h6>
<table class="table table-sm" id="spendingTable"></table>
</div>

<!-- PIE -->
<div class="card p-3 mb-3">
<h6>Spending Analysis</h6>
<canvas id="spendPie" style="max-width:240px"></canvas>
</div>

<div class="d-flex gap-2">
<button class="btn btn-outline-success w-50" onclick="exportExcel()">ğŸ“¤ Export Excel</button>
<button class="btn btn-outline-danger w-50" onclick="resetAll()">Reset All</button>
</div>

</div>

<script>
/* ===== DATA ===== */
let members = JSON.parse(localStorage.getItem("members")) || [];
let expenses = JSON.parse(localStorage.getItem("expenses")) || [];
let owes = {};
let pieChart;
let editIndex = -1;

/* ===== THEME ===== */
function toggleTheme(){
  let h=document.documentElement;
  let t=h.getAttribute("data-bs-theme")==="dark"?"light":"dark";
  h.setAttribute("data-bs-theme",t);
  localStorage.setItem("theme",t);
}
document.documentElement.setAttribute(
  "data-bs-theme", localStorage.getItem("theme") || "dark"
);

/* ===== STORAGE ===== */
function save(){
  localStorage.setItem("members",JSON.stringify(members));
  localStorage.setItem("expenses",JSON.stringify(expenses));
}

/* ===== MEMBERS ===== */
function addMember(){
  let n=memberInput.value.trim();
  if(!n||members.includes(n))return;
  members.push(n);
  memberInput.value="";
  rebuildAll();
}
function deleteMember(i){
  if(!confirm("Delete member?"))return;
  let n=members[i];
  members.splice(i,1);
  expenses=expenses.filter(e=>e.paidBy!==n);
  rebuildAll();
}
function renderMembers(){
  memberList.innerHTML=members.map((m,i)=>`
  <li class="list-group-item d-flex justify-content-between">
    ${m}
    <button class="btn btn-sm btn-outline-danger" onclick="deleteMember(${i})">ğŸ—‘</button>
  </li>`).join("");

  paidBy.innerHTML=members.map(m=>`<option>${m}</option>`).join("");

  customMembers.innerHTML=members.map(m=>`
  <label class="d-flex gap-2 mb-2">
    <input class="form-check-input split-member" type="checkbox" value="${m}">
    <span>${m}</span>
    <input type="number" class="form-control form-control-sm ms-auto split-amount"
           data-member="${m}" placeholder="â‚¹" style="max-width:100px" disabled>
  </label>`).join("");

  document.querySelectorAll(".split-member").forEach(cb=>{
    cb.onchange=()=>{
      let ip=document.querySelector(`.split-amount[data-member="${cb.value}"]`);
      ip.disabled=!cb.checked;
      if(!cb.checked)ip.value="";
    };
  });
}

/* ===== SPLIT ===== */
function selectSplit(t){
  document.getElementById(t==="equal"?"splitEqual":"splitCustom").checked=true;
  toggleSplit();
}
function toggleSplit(){
  customMembers.classList.toggle("show",splitCustom.checked);
}

/* ===== TYPE FIELDS ===== */
function renderTypeFields(){
  const t=expenseType.value;
  const today=new Date().toISOString().split("T")[0];
  typeFields.innerHTML="";
  if(!t)return;

  typeFields.innerHTML=`<input class="form-control mb-2" id="desc" placeholder="Details">
                        <input type="date" class="form-control mb-2" id="date" value="${today}">`;
}

/* ===== SAVE EXPENSE ===== */
function saveExpense(){
  let amt=+expenseAmount.value;
  let paid=paidBy.value;
  let type=expenseType.value;
  let details=document.getElementById("desc")?.value;
  if(!amt||!paid||!type||!details){alert("Fill all fields");return;}

  let splits=[];
  if(splitEqual.checked){
    let s=amt/members.length;
    members.forEach(m=>splits.push({member:m,amount:s}));
  }else{
    document.querySelectorAll(".split-member:checked").forEach(cb=>{
      let v=+document.querySelector(`.split-amount[data-member="${cb.value}"]`).value;
      if(v>0)splits.push({member:cb.value,amount:v});
    });
  }

  let obj={paidBy:paid,amount:amt,type,details,splits};
  if(editIndex>-1)expenses[editIndex]=obj;
  else expenses.push(obj);

  editIndex=-1;
  resetForm();
  rebuildAll();
}

function editExpense(i){
  editIndex=i;
  let e=expenses[i];
  expenseType.value=e.type;
  renderTypeFields();
  expenseAmount.value=e.amount;
  paidBy.value=e.paidBy;
  document.getElementById("desc").value=e.details;

  if(e.splits.length===members.length)selectSplit("equal");
  else{
    selectSplit("custom");
    e.splits.forEach(s=>{
      let cb=document.querySelector(`.split-member[value="${s.member}"]`);
      let ip=document.querySelector(`.split-amount[data-member="${s.member}"]`);
      if(cb&&ip){cb.checked=true;ip.disabled=false;ip.value=s.amount;}
    });
  }

  expenseFormTitle.innerText="Edit Expense";
  cancelEditBtn.classList.remove("d-none");
}
function cancelEdit(){
  editIndex=-1;
  resetForm();
}
function resetForm(){
  expenseType.value="";
  typeFields.innerHTML="";
  expenseAmount.value="";
  splitEqual.checked=true;
  toggleSplit();
  expenseFormTitle.innerText="Add Expense";
  cancelEditBtn.classList.add("d-none");
}

/* ===== OWES ===== */
function initOwes(){
  owes={};
  members.forEach(a=>{
    owes[a]={};
    members.forEach(b=>owes[a][b]=0);
  });
  expenses.forEach(e=>{
    e.splits.forEach(s=>{
      if(s.member!==e.paidBy)owes[s.member][e.paidBy]+=s.amount;
    });
    members.forEach(a=>members.forEach(b=>{
      let m=Math.min(owes[a][b],owes[b][a]);
      owes[a][b]-=m;owes[b][a]-=m;
    }));
  });
}

/* ===== RENDER ===== */
function renderExpenses(){
  expenseTable.innerHTML=`<tr><th>Type</th><th>Details</th><th>Paid</th><th>â‚¹</th><th></th></tr>`+
  expenses.map((e,i)=>`
  <tr>
    <td>${e.type}</td><td>${e.details}</td>
    <td>${e.paidBy}</td><td>${e.amount}</td>
    <td>
      <button class="btn btn-sm btn-outline-primary" onclick="editExpense(${i})">âœï¸</button>
      <button class="btn btn-sm btn-outline-danger" onclick="expenses.splice(${i},1);rebuildAll()">ğŸ—‘</button>
    </td>
  </tr>`).join("");
}
function renderMatrix(){
  let h="";
  members.forEach(f=>{
    let r="";
    members.forEach(t=>{
      if(f!==t&&owes[f][t]>0)
        r+=`<tr><td></td><td>${t}</td><td>â‚¹${owes[f][t].toFixed(2)}</td></tr>`;
    });
    if(r)h+=`<tr class="settle-header"><th colspan="3">${f} should pay</th></tr>${r}`;
  });
  matrixTable.innerHTML=`<tr><th>From</th><th>To</th><th>â‚¹</th></tr>`+
    (h||"<tr><td colspan=3>No dues ğŸ‰</td></tr>");
}
function renderSpending(){
  let m={};members.forEach(x=>m[x]=0);
  expenses.forEach(e=>m[e.paidBy]+=e.amount);
  spendingTable.innerHTML=`<tr><th>Name</th><th>Spent</th></tr>`+
    Object.entries(m).map(([k,v])=>`<tr><td>${k}</td><td>â‚¹${v.toFixed(2)}</td></tr>`).join("");
}
function renderPie(){
  let m={};members.forEach(x=>m[x]=0);
  expenses.forEach(e=>m[e.paidBy]+=e.amount);
  if(pieChart)pieChart.destroy();
  pieChart=new Chart(spendPie,{
    type:"doughnut",
    data:{labels:Object.keys(m),datasets:[{data:Object.values(m)}]},
    options:{plugins:{legend:{position:"bottom"}}}
  });
}

/* ===== EXCEL ===== */
function exportExcel(){
  let wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(expenses),"Expenses");
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(
    Object.entries(renderSpendMap()).map(([k,v])=>({Name:k,Spent:v}))
  ),"Spending");
  let settle=[];
  members.forEach(f=>members.forEach(t=>{
    if(f!==t&&owes[f][t]>0)settle.push({From:f,To:t,Amount:owes[f][t]});
  }));
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(settle),"Settlement");
  XLSX.writeFile(wb,"ExpenseSplitter.xlsx");
}
function renderSpendMap(){
  let m={};members.forEach(x=>m[x]=0);
  expenses.forEach(e=>m[e.paidBy]+=e.amount);
  return m;
}

/* ===== MAIN ===== */
function rebuildAll(){
  save();
  initOwes();
  renderMembers();
  renderExpenses();
  renderMatrix();
  renderSpending();
  renderPie();
}
function resetAll(){
  if(confirm("Clear all data?")){
    localStorage.clear();
    members=[];expenses=[];
    rebuildAll();
  }
}

rebuildAll();
</script>
</body>
</html>
