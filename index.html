<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
<meta charset="UTF-8">
<title>Expense Splitter</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
/* ===== GLOBAL BACKGROUND (SCROLLING) ===== */
body{
  min-height:100vh;
  font-family: system-ui,-apple-system,BlinkMacSystemFont,
               "Segoe UI",Roboto,
               "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji",
               sans-serif;

  background:
    radial-gradient(circle at 20% 20%, rgba(0,123,255,0.25), transparent 40%),
    radial-gradient(circle at 80% 30%, rgba(255,0,150,0.25), transparent 40%),
    radial-gradient(circle at 50% 80%, rgba(0,255,200,0.25), transparent 40%),
    linear-gradient(180deg,#0f2027,#203a43,#2c5364);

  background-attachment: scroll;
  background-size: cover;
  color: var(--bs-body-color);
}

/* ===== GLASS CARD ===== */
.card{
  background: rgba(255,255,255,0.12);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  border-radius:16px;
  border:1px solid rgba(255,255,255,0.2);
  box-shadow:
    0 8px 32px rgba(0,0,0,0.25),
    inset 0 1px 0 rgba(255,255,255,0.15);
}

/* Theme safe */
[data-bs-theme="dark"] .card{
  background: rgba(20,20,20,0.6);
}
[data-bs-theme="light"] .card{
  background: rgba(255,255,255,0.65);
}

input,select,button{border-radius:12px!important}
.table{font-size:14px}

/* Split UI */
.split-card{cursor:pointer}
.split-card:hover{background:rgba(255,255,255,0.08)}

#customMembers{
  max-height:0;
  opacity:0;
  overflow:hidden;
  transition:.3s;
}
#customMembers.show{
  max-height:600px;
  opacity:1;
}

/* Settlement header (theme safe) */
.settle-header{
  background-color: var(--bs-secondary-bg);
  color: var(--bs-body-color);
  font-weight:600;
}
</style>
</head>

<body>
<div class="container my-3">

<div class="d-flex justify-content-between align-items-center mb-3">
  <h4>üí∏ Expense Splitter</h4>
  <button class="btn btn-outline-secondary btn-sm" onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>
</div>

<!-- MEMBERS -->
<div class="card p-3 mb-3">
<h6>Add Member</h6>
<div class="input-group">
<input id="memberInput" class="form-control" placeholder="Member name"
 onkeydown="if(event.key==='Enter')addMember()">
<button class="btn btn-primary" onclick="addMember()">Add</button>
</div>
<ul class="list-group mt-2" id="memberList"></ul>
</div>

<!-- EXPENSE FORM -->
<div class="card p-3 mb-3">
<h6 id="expenseFormTitle">Add Expense</h6>

<select class="form-select mb-2" id="expenseType" onchange="renderTypeFields()">
  <option value="">Expense type</option>
  <option value="Travel">üöï Travel</option>
  <option value="Food">üçî Food</option>
  <option value="Other">üõí Other</option>
</select>

<div id="typeFields"></div>

<input id="expenseAmount" type="number" class="form-control mb-2" placeholder="Amount ‚Çπ">
<select id="paidBy" class="form-select mb-2"></select>

<div class="card p-2 mb-2 split-card" onclick="selectSplit('equal')">
  <input type="radio" id="splitEqual" name="splitType" checked>
  <label for="splitEqual">Split equally</label>
</div>

<div class="card p-2 mb-2 split-card" onclick="selectSplit('custom')">
  <input type="radio" id="splitCustom" name="splitType">
  <label for="splitCustom">Split selected members</label>
</div>

<div id="customMembers"></div>

<button class="btn btn-success w-100 mt-3" onclick="saveExpense()">Save Expense</button>
<button class="btn btn-outline-secondary w-100 mt-2 d-none" id="cancelEditBtn" onclick="cancelEdit()">Cancel Edit</button>
</div>

<!-- EXPENSE LIST -->
<div class="card p-3 mb-3">
<h6>Expenses</h6>
<table class="table table-sm" id="expenseTable"></table>
</div>

<!-- SETTLEMENT -->
<div class="card p-3 mb-3">
<h6>Final Settlement</h6>
<table class="table table-sm" id="matrixTable"></table>
</div>

<!-- SPENDING -->
<div class="card p-3 mb-3">
<h6>Total Individual Spending</h6>
<table class="table table-sm" id="spendingTable"></table>
</div>

<!-- GRAPH -->
<div class="card p-3 mb-3 text-center">
<h6>Spending Analysis</h6>
<canvas id="spendPie" style="max-width:220px"></canvas>
</div>

<div class="d-flex gap-2">
<button class="btn btn-outline-success w-50" onclick="exportExcel()">üì§ Export Excel</button>
<button class="btn btn-outline-danger w-50" onclick="resetAll()">Reset All</button>
</div>

</div>

<script>
/* ================= DATA ================= */
let members = JSON.parse(localStorage.getItem("members")) || [];
let expenses = JSON.parse(localStorage.getItem("expenses")) || [];
let owes = {};
let pieChart;
let editIndex = -1;

/* ================= THEME ================= */
function toggleTheme(){
  const h=document.documentElement;
  const t=h.getAttribute("data-bs-theme")==="dark"?"light":"dark";
  h.setAttribute("data-bs-theme",t);
  localStorage.setItem("theme",t);
  renderPie();
}
document.documentElement.setAttribute(
  "data-bs-theme",localStorage.getItem("theme")||"dark"
);

/* ================= STORAGE ================= */
function save(){
  localStorage.setItem("members",JSON.stringify(members));
  localStorage.setItem("expenses",JSON.stringify(expenses));
}

/* ================= MEMBERS ================= */
function addMember(){
  const n=memberInput.value.trim();
  if(!n||members.includes(n))return;
  members.push(n);
  memberInput.value="";
  rebuildAll();
}
function deleteMember(i){
  if(!confirm("Delete member?"))return;
  const n=members[i];
  members.splice(i,1);
  expenses=expenses.filter(e=>e.paidBy!==n);
  rebuildAll();
}
function renderMembers(){
  memberList.innerHTML=members.map((m,i)=>`
    <li class="list-group-item d-flex justify-content-between">
      ${m}
      <button class="btn btn-sm btn-outline-danger" onclick="deleteMember(${i})">üóë</button>
    </li>`).join("");
  paidBy.innerHTML=members.map(m=>`<option>${m}</option>`).join("");

  customMembers.innerHTML=members.map(m=>`
    <label class="d-flex align-items-center gap-2 mb-2">
      <input type="checkbox" class="split-member" value="${m}">
      <span>${m}</span>
      <input type="number" class="form-control form-control-sm ms-auto split-amount"
        data-member="${m}" placeholder="‚Çπ" style="max-width:90px" disabled>
    </label>`).join("");

  document.querySelectorAll(".split-member").forEach(cb=>{
    cb.onchange=()=>{
      const ip=document.querySelector(`.split-amount[data-member="${cb.value}"]`);
      ip.disabled=!cb.checked;
      if(!cb.checked)ip.value="";
    };
  });
}

/* ================= SPLIT ================= */
function selectSplit(t){
  document.getElementById(t==="equal"?"splitEqual":"splitCustom").checked=true;
  customMembers.classList.toggle("show",t==="custom");
}

/* ================= EXPENSE TYPE FIELDS ================= */
function renderTypeFields(){
  const t=expenseType.value;
  const d=new Date().toISOString().split("T")[0];
  typeFields.innerHTML="";
  if(!t)return;

  if(t==="Travel"){
    typeFields.innerHTML=`
      <select class="form-select mb-2" id="travelMode">
        <option>Bus</option><option>Train</option>
        <option>Flight</option><option>Car</option>
        <option value="Other">Other</option>
      </select>
      <input class="form-control mb-2 d-none" id="travelOther" placeholder="Other transport">
      <input class="form-control mb-2" id="fromPlace" placeholder="From">
      <input class="form-control mb-2" id="toPlace" placeholder="To">
      <input type="date" class="form-control mb-2" id="travelDate" value="${d}">
    `;
    travelMode.onchange=()=>travelOther.classList.toggle("d-none",travelMode.value!=="Other");
  }
  if(t==="Food"){
    typeFields.innerHTML=`
      <input class="form-control mb-2" id="foodPlace" placeholder="Place">
      <select class="form-select mb-2" id="foodType">
        <option>Breakfast</option><option>Lunch</option>
        <option>Dinner</option><option>Snacks</option>
        <option value="Other">Other</option>
      </select>
      <input class="form-control mb-2 d-none" id="foodOther" placeholder="Other food">
      <input type="date" class="form-control mb-2" id="foodDate" value="${d}">
    `;
    foodType.onchange=()=>foodOther.classList.toggle("d-none",foodType.value!=="Other");
  }
  if(t==="Other"){
    typeFields.innerHTML=`
      <input class="form-control mb-2" id="otherText" placeholder="Description">
      <input class="form-control mb-2" id="otherPlace" placeholder="Place">
      <input type="date" class="form-control mb-2" id="otherDate" value="${d}">
    `;
  }
}

/* ================= EXPENSE CRUD ================= */
function saveExpense(){
  const amount=+expenseAmount.value;
  if(!amount||!paidBy.value||!expenseType.value)return alert("Fill all fields");

  let details="";
  if(expenseType.value==="Travel")
    details=`${travelMode.value} | ${fromPlace.value} ‚Üí ${toPlace.value} | ${travelDate.value}`;
  if(expenseType.value==="Food")
    details=`${foodPlace.value} | ${foodType.value} | ${foodDate.value}`;
  if(expenseType.value==="Other")
    details=`${otherText.value} | ${otherPlace.value} | ${otherDate.value}`;

  let splits=[];
  if(splitEqual.checked){
    const s=amount/members.length;
    members.forEach(m=>splits.push({member:m,amount:s}));
  }else{
    document.querySelectorAll(".split-member:checked").forEach(cb=>{
      const v=+document.querySelector(`.split-amount[data-member="${cb.value}"]`).value;
      if(v>0)splits.push({member:cb.value,amount:v});
    });
    }

  const obj={paidBy:paidBy.value,amount,type:expenseType.value,details,splits};
  if(editIndex>-1)expenses[editIndex]=obj;
  else expenses.push(obj);

  cancelEdit();
  rebuildAll();
}

function editExpense(i){
  const e=expenses[i];
  editIndex=i;
  expenseFormTitle.innerText="Edit Expense";
  cancelEditBtn.classList.remove("d-none");
  expenseType.value=e.type;
  renderTypeFields();
  expenseAmount.value=e.amount;
  paidBy.value=e.paidBy;
}

function deleteExpense(i){
  if(confirm("Delete expense?")){
    expenses.splice(i,1);
    rebuildAll();
  }
}

function cancelEdit(){
  editIndex=-1;
  expenseFormTitle.innerText="Add Expense";
  cancelEditBtn.classList.add("d-none");
  expenseType.value="";
  typeFields.innerHTML="";
  expenseAmount.value="";
  splitEqual.checked=true;
  customMembers.classList.remove("show");
}

/* ================= CALC ================= */
function initOwes(){
  owes={};
  members.forEach(a=>{owes[a]={};members.forEach(b=>owes[a][b]=0);});
  expenses.forEach(e=>{
    e.splits.forEach(s=>{
      if(s.member!==e.paidBy)owes[s.member][e.paidBy]+=s.amount;
    });
    members.forEach(a=>members.forEach(b=>{
      const m=Math.min(owes[a][b],owes[b][a]);
      owes[a][b]-=m;owes[b][a]-=m;
    }));
  });
}

/* ================= RENDER ================= */
function renderExpenses(){
  expenseTable.innerHTML=
  `<tr><th>Type</th><th>Details</th><th>Paid</th><th>‚Çπ</th><th></th></tr>`+
  expenses.map((e,i)=>`
    <tr>
      <td>${e.type}</td>
      <td>${e.details}</td>
      <td>${e.paidBy}</td>
      <td>${e.amount}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary" onclick="editExpense(${i})">‚úèÔ∏è</button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteExpense(${i})">üóë</button>
      </td>
    </tr>`).join("");
}
function renderMatrix(){
  let h="";
  members.forEach(f=>{
    let r="";
    members.forEach(t=>{
      if(f!==t&&owes[f][t]>0)
        r+=`<tr><td></td><td>${t}</td><td>‚Çπ${owes[f][t].toFixed(2)}</td></tr>`;
    });
    if(r)h+=`<tr class="settle-header"><th colspan="3">${f} should pay</th></tr>${r}`;
  });
  matrixTable.innerHTML=`<tr><th>From</th><th>To</th><th>‚Çπ</th></tr>`+(h||"<tr><td colspan=3>No dues üéâ</td></tr>");
}
function renderSpending(){
  let m={};members.forEach(x=>m[x]=0);
  expenses.forEach(e=>m[e.paidBy]+=e.amount);
  spendingTable.innerHTML=`<tr><th>Name</th><th>Spent</th></tr>`+
    Object.entries(m).map(([k,v])=>`<tr><td>${k}</td><td>‚Çπ${v.toFixed(2)}</td></tr>`).join("");
}
function renderPie(){
  let m={};members.forEach(x=>m[x]=0);
  expenses.forEach(e=>m[e.paidBy]+=e.amount);
  if(pieChart)pieChart.destroy();
  pieChart=new Chart(spendPie,{
    type:"doughnut",
    data:{labels:Object.keys(m),datasets:[{data:Object.values(m)}]},
    options:{cutout:"70%",plugins:{legend:{position:"bottom"}}}
  });
}

/* ================= EXCEL ================= */
function exportExcel(){
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(expenses),"Expenses");
  XLSX.writeFile(wb,"ExpenseSplitter.xlsx");
}

/* ================= MAIN ================= */
function rebuildAll(){
  save(); initOwes(); renderMembers(); renderExpenses(); renderMatrix(); renderSpending(); renderPie();
}
function resetAll(){
  if(confirm("Clear all data?")){
    localStorage.clear();
    members=[];expenses=[];
    rebuildAll();
  }
}

initOwes();renderMembers();renderExpenses();renderMatrix();renderSpending();renderPie();
</script>
</body>
</html>
